
import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { \n    MessageSquare, Star, Send, ShieldCheck, BookOpen, Flame, PenTool, \n    CheckCircle, XCircle, User, Calendar, ThumbsUp, Filter, TrendingUp, Clock, AlertOctagon, Loader, UserPlus\n} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { SiteReview, CodexPost } from '../types';
import { Atlas } from '../services/atlasService';
import ReactMarkdown from 'react-markdown';

const MotionDiv = motion.div as any;

// --- SORTING & FILTERING LOGIC ---
type ReviewSort = 'NEWEST' | 'TOP_RATED';
type CodexSort = 'NEWEST' | 'MOST_VOTED';

// --- UI/UX: REFINED & ENCAPSULATED COMPONENTS ---

const ReviewCard: React.FC<{ review: SiteReview }> = ({ review }) => (\n    <MotionDiv layout initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}\n        className=\"bg-slate-900/50 border border-slate-800 p-6 rounded-xl\">\n        <div className=\"flex justify-between items-start mb-3\">\n            <div className=\"flex items-center gap-3\">\n                <div className=\"w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700\"><User className=\"w-4 h-4 text-slate-400\" /></div>\n                <div>\n                    <div className=\"text-sm font-bold text-white\">{review.user}</div>\n                    <div className=\"text-[10px] text-slate-500 font-mono\">{new Date(review.timestamp).toLocaleDateString()}</div>\n                </div>\n            </div>\n            <div className=\"flex gap-1\">\n                {Array.from({length: 5}).map((_, i) => <Star key={i} className={`w-3 h-3 ${i < review.rating ? 'text-amber-400 fill-current' : 'text-slate-800'}`} />)}\n            </div>\n        </div>\n        <p className=\"text-slate-300 text-sm leading-relaxed\">{review.comment}</p>\n    </MotionDiv>\n);\n
const CodexCard: React.FC<{ post: CodexPost, onVote: (id: string) => void }> = ({ post, onVote }) => (\n    <MotionDiv layout initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}\n        className=\"bg-slate-900 border border-slate-800 p-6 rounded-xl hover:border-indigo-500/30 transition-all group\">\n        <div className=\"flex justify-between items-start mb-4\">\n            <h3 className=\"text-lg font-bold text-white group-hover:text-indigo-300 transition-colors flex-1 pr-4\">{post.title}</h3>\n            <button onClick={() => onVote(post.id)} className=\"flex items-center gap-1.5 text-xs font-mono text-slate-500 hover:text-emerald-400 bg-slate-950 px-2 py-1 rounded border border-slate-800 transition-colors\">\n                <ThumbsUp className=\"w-3 h-3\" /> {post.votes}\n            </button>\n        </div>\n        <div className=\"prose prose-invert prose-sm max-w-none text-slate-400 mb-4 line-clamp-3\"><ReactMarkdown>{post.content}</ReactMarkdown></div>\n        <div className=\"flex items-center justify-between text-[10px] text-slate-500 font-mono uppercase tracking-widest pt-4 border-t border-slate-800/50\">\n            <span className=\"flex items-center gap-2\"><User className=\"w-3 h-3\" /> {post.author}</span>\n            <div className=\"flex items-center gap-2\">\n                {(post.tags || []).slice(0, 2).map(tag => <span key={tag} className=\"px-1.5 bg-slate-800 rounded\">{tag}</span>)}\n            </div>\n        </div>\n    </MotionDiv>\n);\n
const SortControl: React.FC<{ sort: string, setSort: (sort: any) => void, options: {value: string, label: string, icon: React.ReactNode}[]}> = ({ sort, setSort, options }) => (\n    <div className=\"flex items-center gap-2 bg-slate-900/80 border border-slate-800 p-1 rounded-lg\">\n        {options.map(opt => (\n            <button key={opt.value} onClick={() => setSort(opt.value)}\n                className={`flex items-center gap-1.5 px-3 py-1 rounded text-xs font-semibold transition-colors ${sort === opt.value ? 'bg-slate-700 text-white' : 'text-slate-400 hover:bg-slate-800'}`}\n            >\n                {opt.icon}{opt.label}\n            </button>\n        ))}\n    </div>\n);

export default function Community() {\n    const [activeTab, setActiveTab] = useState<'REVIEWS' | 'CODEX'>('REVIEWS');\n    \n    // --- REVIEW STATE ---
    const [reviews, setReviews] = useState<SiteReview[]>([]);\n    const [rating, setRating] = useState(5);\n    const [reviewText, setReviewText] = useState('');\n    const [reviewerName, setReviewerName] = useState('');\n    const [reviewSort, setReviewSort] = useState<ReviewSort>('NEWEST');

    // --- CODEX STATE ---
    const [codexPosts, setCodexPosts] = useState<CodexPost[]>([]);\n    const [postTitle, setPostTitle] = useState('');\n    const [postContent, setPostContent] = useState('');
    const [postAuthor, setPostAuthor] = useState('');
    const [codexSort, setCodexSort] = useState<CodexSort>('MOST_VOTED');
    const [isJudging, setIsJudging] = useState(false);\n    const [verdict, setVerdict] = useState<{ approved: boolean, reason: string } | null>(null);\n    const [judgementError, setJudgementError] = useState<string | null>(null);\n
    // Load Data
    useEffect(() => {\n        const savedReviews = localStorage.getItem('atlas_reviews');\n        if (savedReviews) setReviews(JSON.parse(savedReviews));\n        const savedCodex = localStorage.getItem('atlas_codex');\n        if (savedCodex) setCodexPosts(JSON.parse(savedCodex));\n    }, []);\n
    // Save Data
    useEffect(() => { localStorage.setItem('atlas_reviews', JSON.stringify(reviews)); }, [reviews]);\n    useEffect(() => { localStorage.setItem('atlas_codex', JSON.stringify(codexPosts)); }, [codexPosts]);

    const sortedReviews = useMemo(() => {\n        return [...reviews].sort((a, b) => {\n            if (reviewSort === 'TOP_RATED') return b.rating - a.rating;\n            return b.timestamp - a.timestamp; // NEWEST (default)\n        });\n    }, [reviews, reviewSort]);

    const sortedCodexPosts = useMemo(() => {\n        return [...codexPosts].sort((a, b) => {\n            if (codexSort === 'MOST_VOTED') return b.votes - a.votes;\n            return b.timestamp - a.timestamp; // NEWEST (default)\n        });\n    }, [codexPosts, codexSort]);

    const submitReview = () => {\n        if (!reviewText.trim() || !reviewerName.trim()) return;\n        const newReview: SiteReview = {\n            id: crypto.randomUUID(), user: reviewerName, rating, comment: reviewText, timestamp: Date.now()\n        };\n        setReviews([newReview, ...reviews]);\n        setReviewText(''); setReviewerName(''); setRating(5);\n    };\n
    const submitToCodex = useCallback(async () => {\n        if (!postTitle.trim() || !postContent.trim() || !postAuthor.trim()) return;\n        setIsJudging(true);\n        setVerdict(null);\n        setJudgementError(null);\n\n        const prompt = `\n            You are the Codex Guardian, a strict AI curator of a technical knowledge base for elite software engineers.\n            Analyze the following submission and decide if it meets the standards of quality.\n            **Submission Title:** ${postTitle}\n            **Submission Content:** ${postContent}\n\n            **Criteria for Acceptance:**\n            1.  **Technical Accuracy:** Is the information correct and not misleading?\n            2.  **Clarity & Depth:** Is the explanation clear, concise, and sufficiently detailed?\n            3.  **Utility & Relevance:** Is this knowledge genuinely useful to a professional engineer?\n
            **Your Response:**\n            You MUST return a single, raw JSON object with three keys:\n            - \`approved\`: \`true\` or \`false\`.\n            - \`reason\`: A brief, one-sentence justification for your decision. (e.g., \"Provides a clear, actionable guide to database indexing.\" or \"The explanation of memory management is superficial and lacks depth.\").\n            - \`tags\`: An array of 2-3 relevant, single-word, uppercase technical tags. (e.g., [\"DATABASE\", \"OPTIMIZATION\", \"SQL\"])\n        `;\n\n        try {\n            const response = await Atlas.generate(prompt, { isJson: true }) as { data: { approved: boolean, reason: string, tags: string[] } };\n            const result = response.data;\n
            setVerdict({ approved: result.approved, reason: result.reason });\n
            if (result.approved) {\n                const newPost: CodexPost = {\n                    id: crypto.randomUUID(), title: postTitle, content: postContent, author: postAuthor,\n                    timestamp: Date.now(), votes: 1, tags: result.tags, atlasVerdict: 'APPROVED'\n                };\n                setCodexPosts(p => [newPost, ...p]);\n                setPostTitle(''); setPostContent(''); setPostAuthor('');\n            }\n        } catch (e) {\n            console.error(e);\n            setJudgementError(\"The Codex Guardian is currently offline. Your submission could not be judged.\");\n        } finally {\n            setIsJudging(false);\n            setTimeout(() => { setVerdict(null); setJudgementError(null); }, 5000);\n        }\n    }, [postTitle, postContent, postAuthor]);

    const votePost = (id: string) => {\n        setCodexPosts(codexPosts.map(p => p.id === id ? { ...p, votes: p.votes + 1 } : p));\n    };\n    \n    const codexFormFilled = postTitle.trim() && postContent.trim() && postAuthor.trim();

    return (\n        <div className=\"h-full bg-[#020617] text-slate-300 overflow-y-auto custom-scrollbar flex flex-col relative\">\n            <div className=\"absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:60px_60px] pointer-events-none\" />\n            <main className=\"max-w-7xl mx-auto w-full p-4 md:p-8 relative z-10 flex-1 flex flex-col\">\n                {/* ... Header ... */}\n                <div className=\"flex-1 flex flex-col\">\n                    <AnimatePresence mode=\"wait\">\n                        {activeTab === 'REVIEWS' ? (\n                            <MotionDiv key=\"reviews\" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }}\n                                className=\"grid grid-cols-1 lg:grid-cols-12 gap-10\">\n                                <div className=\"lg:col-span-4 space-y-6\">{/* Review Form */}</div>\n                                <div className=\"lg:col-span-8 space-y-4\">\n                                    <div className=\"flex flex-wrap items-center justify-between gap-4 mb-2\">\n                                        <h3 className=\"text-xs font-bold text-slate-500 uppercase tracking-widest\">Community Feedback ({reviews.length})</h3>\n                                        <SortControl sort={reviewSort} setSort={setReviewSort} options={[\n                                            {value: 'NEWEST', label: 'Newest', icon: <Clock className=\"w-3 h-3\" />},\n                                            {value: 'TOP_RATED', label: 'Top Rated', icon: <Star className=\"w-3 h-3\" />} ]}/>\n                                    </div>\n                                    <AnimatePresence> {sortedReviews.map(review => <ReviewCard key={review.id} review={review} />)} </AnimatePresence>\n                                </div>\n                            </MotionDiv>\n                        ) : (\n                            <MotionDiv key=\"codex\" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }}\n                                className=\"grid grid-cols-1 lg:grid-cols-12 gap-10\">\n                                <div className=\"lg:col-span-5 space-y-6\">\n                                    <div className=\"bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-xl relative overflow-hidden\">\n                                         <AnimatePresence>\n                                            {(verdict || judgementError) && (\n                                                <MotionDiv initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}\n                                                    className={`absolute top-4 right-4 left-4 z-20 p-3 rounded-lg border flex items-start gap-2 text-xs \n                                                        ${judgementError ? \"bg-yellow-900/40 border-yellow-500/50 text-yellow-200\" : verdict?.approved ? \"bg-emerald-900/40 border-emerald-500/50 text-emerald-200\" : \"bg-red-900/40 border-red-500/50 text-red-200\"}`}\n                                                >\n                                                    {judgementError ? <AlertOctagon className=\"w-4 h-4 flex-shrink-0 mt-0.5\" /> : verdict?.approved ? <CheckCircle className=\"w-4 h-4 flex-shrink-0 mt-0.5\" /> : <XCircle className=\"w-4 h-4 flex-shrink-0 mt-0.5\" />}\n                                                    <p>{judgementError || verdict?.reason}</p>\n                                                </MotionDiv>\n                                            )}
                                        </AnimatePresence>\n                                        <h3 className=\"text-sm font-bold text-white uppercase tracking-widest mb-6 flex items-center gap-2\"><PenTool className=\"w-4 h-4 text-indigo-500\" /> Contribute to Codex</h3>\n                                        <div className=\"space-y-4\"><input value={postAuthor} onChange={e => setPostAuthor(e.target.value)} placeholder=\"Your Name\"/><input value={postTitle} onChange={e => setPostTitle(e.target.value)} placeholder=\"e.g., Optimizing React Renders\"/><textarea value={postContent} onChange={e => setPostContent(e.target.value)} placeholder=\"Share your knowledge...\"/></div>\n                                        <button onClick={submitToCodex} disabled={!codexFormFilled || isJudging} className=\"w-full ...\"><Flame className=\"w-4 h-4 text-red-500\" /> {isJudging ? 'JUDGING...\' : 'SUBMIT TO GUARDIAN'}</button>\n                                        {isJudging && <div className=\"absolute inset-0 bg-slate-950/80 z-10 flex items-center justify-center\"><Loader className=\"animate-spin text-indigo-500\"/></div>}\n                                    </div>\n                                </div>\n                                <div className=\"lg:col-span-7 space-y-4\">\n                                     <div className=\"flex flex-wrap items-center justify-between gap-4 mb-2\">\n                                        <h3 className=\"text-xs font-bold text-slate-500 uppercase tracking-widest\">Permanent Records ({codexPosts.length})</h3>\n                                        <SortControl sort={codexSort} setSort={setCodexSort} options={[\n                                            {value: 'MOST_VOTED', label: 'Most Voted', icon: <TrendingUp className=\"w-3 h-3\" />},\n                                            {value: 'NEWEST', label: 'Newest', icon: <Clock className=\"w-3 h-3\" />}]}/>\n                                    </div>\n                                    <AnimatePresence>{sortedCodexPosts.map(post => <CodexCard key={post.id} post={post} onVote={votePost} />)}</AnimatePresence>\n                                </div>\n                            </MotionDiv>\n                        )}\n                    </AnimatePresence>\n                </div>\n            </main>\n        </div>\n    );\n}\n